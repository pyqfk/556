<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡µé¢è®¿é—®ç›‘æ§ç³»ç»Ÿ - è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 4px solid #4facfe;
        }
        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        .config-section {
            grid-column: 1 / -1;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: #4facfe;
            color: white;
        }
        .btn-primary:hover {
            background: #3a9bfc;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .status-log {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }
        .log-success { background: #28a745; }
        .log-error { background: #dc3545; }
        .log-warning { background: #ffc107; color: #212529; }
        .log-info { background: #17a2b8; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        .info-item strong {
            display: block;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .request-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .json-view {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }
        .diagnosis-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .solution-steps {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            .config-section {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” é¡µé¢è®¿é—®ç›‘æ§ç³»ç»Ÿè¯Šæ–­å·¥å…·</h1>
            <p>è¯Šæ–­å’Œè§£å†³é˜¿é‡Œäº‘å‡½æ•°è®¡ç®—è¿æ¥é—®é¢˜</p>
        </div>
        
        <div class="content">
            <div class="panel config-section">
                <h2>âš™ï¸ å‡½æ•°é…ç½®</h2>
                <div class="input-group">
                    <label for="functionUrl">å‡½æ•°è®¡ç®—URLåœ°å€ï¼š</label>
                    <input type="text" id="functionUrl" 
                           value="https://page-mofunction-khbohtokia.cn-hangzhou.fcapp.run"
                           placeholder="è¯·è¾“å…¥æ‚¨çš„å‡½æ•°è®¡ç®—URL">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button class="btn btn-info" onclick="testConnection()">ğŸ”— æµ‹è¯•è¿æ¥</button>
                    <button class="btn btn-success" onclick="sendAccessRecord()">ğŸ“¨ å‘é€è®¿é—®è®°å½•</button>
                    <button class="btn btn-warning" onclick="testWithMockData()">ğŸ§ª æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•</button>
                    <button class="btn btn-danger" onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
                </div>
            </div>

            <div class="panel">
                <h2>ğŸ“Š ç³»ç»ŸçŠ¶æ€</h2>
                <div class="status-log" id="statusLog">
                    <div class="log-entry log-info">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>

            <div class="panel">
                <h2>ğŸŒ è®¿é—®ç¯å¢ƒä¿¡æ¯</h2>
                <div class="info-grid" id="environmentInfo">
                    <!-- ç¯å¢ƒä¿¡æ¯å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <div class="panel">
                <h2>ğŸ“ è¯·æ±‚è¯¦æƒ…</h2>
                <div class="request-details">
                    <strong>è¯·æ±‚URLï¼š</strong>
                    <div id="requestUrl">ç­‰å¾…é…ç½®...</div>
                    
                    <strong>è¯·æ±‚æ•°æ®ï¼š</strong>
                    <div class="json-view" id="requestData">ç­‰å¾…è¯·æ±‚...</div>
                    
                    <strong>å“åº”çŠ¶æ€ï¼š</strong>
                    <div id="responseStatus">æœªå‘é€</div>
                    
                    <strong>å“åº”æ•°æ®ï¼š</strong>
                    <div class="json-view" id="responseData">ç­‰å¾…å“åº”...</div>
                </div>
            </div>

            <div class="diagnosis-section">
                <h2>ğŸ”§ é—®é¢˜è¯Šæ–­</h2>
                <div id="diagnosisResult">
                    <p>ç‚¹å‡»"æµ‹è¯•è¿æ¥"å¼€å§‹è¯Šæ–­...</p>
                </div>
            </div>

            <div class="solution-steps">
                <h2>ğŸ’¡ è§£å†³æ–¹æ¡ˆ</h2>
                <div id="solutionSteps">
                    <p>æ ¹æ®è¯Šæ–­ç»“æœæä¾›å…·ä½“è§£å†³æ–¹æ¡ˆ...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®ç®¡ç†
        const CONFIG_KEY = 'fc_monitor_config';
        
        // åˆå§‹åŒ–é…ç½®
        function loadConfig() {
            const saved = localStorage.getItem(CONFIG_KEY);
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('functionUrl').value = config.url || '';
            }
            updateEnvironmentInfo();
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const url = document.getElementById('functionUrl').value.trim();
            if (!url) {
                log('è¯·è¾“å…¥æœ‰æ•ˆçš„URLåœ°å€', 'error');
                return;
            }
            
            const config = { url, timestamp: new Date().toISOString() };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            log('é…ç½®å·²ä¿å­˜', 'success');
            updateRequestDetails();
        }

        // æ›´æ–°ç¯å¢ƒä¿¡æ¯
        function updateEnvironmentInfo() {
            const info = {
                'é¡µé¢URL': window.location.href,
                'ç”¨æˆ·ä»£ç†': navigator.userAgent,
                'å±å¹•åˆ†è¾¨ç‡': `${screen.width} Ã— ${screen.height}`,
                'è‰²å½©æ·±åº¦': `${screen.colorDepth}ä½`,
                'è¯­è¨€è®¾ç½®': navigator.language,
                'æ¥æºé¡µé¢': document.referrer || 'ç›´æ¥è®¿é—®',
                'Cookieå¯ç”¨': navigator.cookieEnabled ? 'æ˜¯' : 'å¦',
                'åœ¨çº¿çŠ¶æ€': navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿',
                'è®¿é—®æ—¶é—´': new Date().toLocaleString(),
                'æ—¶åŒºåç§»': new Date().getTimezoneOffset() + 'åˆ†é’Ÿ'
            };

            const container = document.getElementById('environmentInfo');
            container.innerHTML = '';
            
            Object.entries(info).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'info-item';
                item.innerHTML = `<strong>${key}</strong><span>${value}</span>`;
                container.appendChild(item);
            });
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            const url = getFunctionUrl();
            if (!url) return;

            log(`æµ‹è¯•è¿æ¥åˆ°: ${url}`, 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    }
                });
                
                if (response.ok) {
                    log('âœ… è¿æ¥æµ‹è¯•æˆåŠŸ - æœåŠ¡å¯è®¿é—®', 'success');
                    showDiagnosis('è¿æ¥æ­£å¸¸', 'success');
                    showSolutions(['æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥å‘é€è®¿é—®è®°å½•']);
                } else {
                    log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                    diagnoseConnectionIssue(response.status);
                }
            } catch (error) {
                log(`âŒ è¿æ¥é”™è¯¯: ${error.message}`, 'error');
                diagnoseConnectionIssue(0, error.message);
            }
        }

        // å‘é€è®¿é—®è®°å½•
        async function sendAccessRecord() {
            const url = getFunctionUrl();
            if (!url) return;

            const requestData = {
                pageUrl: window.location.href,
                userAgent: navigator.userAgent,
                referer: document.referrer,
                screen: `${screen.width}x${screen.height}`,
                language: navigator.language,
                timestamp: Date.now()
            };

            log('å‡†å¤‡å‘é€è®¿é—®è®°å½•...', 'info');
            updateRequestDetails(url, requestData);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const responseText = await response.text();
                updateResponseDetails(response.status, responseText);

                if (response.ok) {
                    log('âœ… è®¿é—®è®°å½•å‘é€æˆåŠŸ', 'success');
                } else {
                    log(`âŒ å‘é€å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                updateResponseDetails(0, error.message);
            }
        }

        // æ¨¡æ‹Ÿæ•°æ®æµ‹è¯•
        async function testWithMockData() {
            const url = getFunctionUrl();
            if (!url) return;

            const mockData = {
                pageUrl: "https://example.com/test-page",
                userAgent: "Mozilla/5.0 (æµ‹è¯•ç”¨æˆ·ä»£ç†)",
                referer: "https://google.com",
                screen: "1920x1080",
                language: "zh-CN",
                timestamp: Date.now(),
                testMode: true
            };

            log('ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæµ‹è¯•...', 'info');
            updateRequestDetails(url, mockData);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mockData)
                });

                const responseText = await response.text();
                updateResponseDetails(response.status, responseText);

                if (response.ok) {
                    log('âœ… æ¨¡æ‹Ÿæµ‹è¯•æˆåŠŸ', 'success');
                } else {
                    log(`âŒ æ¨¡æ‹Ÿæµ‹è¯•å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ æ¨¡æ‹Ÿæµ‹è¯•é”™è¯¯: ${error.message}`, 'error');
                updateResponseDetails(0, error.message);
            }
        }

        // å·¥å…·å‡½æ•°
        function getFunctionUrl() {
            const url = document.getElementById('functionUrl').value.trim();
            if (!url) {
                log('è¯·å…ˆé…ç½®å‡½æ•°URLåœ°å€', 'error');
                return null;
            }
            return url;
        }

        function updateRequestDetails(url, data) {
            document.getElementById('requestUrl').textContent = url || 'æœªé…ç½®';
            document.getElementById('requestData').textContent = data ? 
                JSON.stringify(data, null, 2) : 'ç­‰å¾…è¯·æ±‚...';
        }

        function updateResponseDetails(status, data) {
            document.getElementById('responseStatus').textContent = 
                status ? `${status} ${getStatusText(status)}` : 'è¯·æ±‚å¤±è´¥';
            document.getElementById('responseData').textContent = 
                data ? (typeof data === 'string' ? data : JSON.stringify(data, null, 2)) : 'æ— å“åº”æ•°æ®';
        }

        function getStatusText(status) {
            const statusTexts = {
                200: 'OK', 201: 'Created', 400: 'Bad Request', 
                401: 'Unauthorized', 403: 'Forbidden', 404: 'Not Found',
                500: 'Internal Server Error'
            };
            return statusTexts[status] || 'Unknown Status';
        }

        function log(message, type = 'info') {
            const logElement = document.getElementById('statusLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleString()} - ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('statusLog').innerHTML = 
                '<div class="log-entry log-info">æ—¥å¿—å·²æ¸…é™¤</div>';
        }

        function diagnoseConnectionIssue(status, errorMessage = '') {
            let diagnosis = '';
            let solutions = [];

            if (status === 0) {
                diagnosis = 'ç½‘ç»œè¿æ¥å®Œå…¨å¤±è´¥';
                solutions = [
                    'æ£€æŸ¥URLåœ°å€æ˜¯å¦æ­£ç¡®ï¼ˆåº”ä»¥https://å¼€å¤´ï¼‰',
                    'å°è¯•ä½¿ç”¨curlå‘½ä»¤æµ‹è¯•ï¼šcurl -X POST "æ‚¨çš„URL"',
                    'æ£€æŸ¥ç½‘ç»œé˜²ç«å¢™è®¾ç½®',
                    'å°è¯•æ›´æ¢ç½‘ç»œç¯å¢ƒæˆ–ä½¿ç”¨VPN',
                    'ç¡®è®¤å‡½æ•°è®¡ç®—æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ'
                ];
            } else if (status === 403) {
                diagnosis = 'è®¿é—®è¢«æ‹’ç»ï¼ˆè®¤è¯é—®é¢˜ï¼‰';
                solutions = [
                    'æ£€æŸ¥è§¦å‘å™¨è®¤è¯æ–¹å¼æ˜¯å¦ä¸º"åŒ¿å"',
                    'ç¡®è®¤å‡½æ•°æ‰§è¡Œè§’è‰²æœ‰è¶³å¤Ÿæƒé™',
                    'æ£€æŸ¥APIç½‘å…³çš„è®¿é—®æ§åˆ¶è®¾ç½®'
                ];
            } else if (status === 404) {
                diagnosis = 'æœåŠ¡æœªæ‰¾åˆ°';
                solutions = [
                    'ç¡®è®¤URLåœ°å€å®Œå…¨æ­£ç¡®',
                    'æ£€æŸ¥å‡½æ•°æ˜¯å¦å·²éƒ¨ç½²æˆåŠŸ',
                    'ç¡®è®¤è§¦å‘å™¨é…ç½®æ­£ç¡®'
                ];
            } else if (status === 500) {
                diagnosis = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
                solutions = [
                    'æ£€æŸ¥å‡½æ•°ä»£ç æ˜¯å¦æœ‰è¯­æ³•é”™è¯¯',
                    'æŸ¥çœ‹å‡½æ•°è®¡ç®—æ—¥å¿—è¯¦æƒ…',
                    'ç¡®è®¤ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®'
                ];
            } else {
                diagnosis = `HTTP ${status} é”™è¯¯`;
                solutions = [
                    'æŸ¥çœ‹é˜¿é‡Œäº‘å‡½æ•°è®¡ç®—æ–‡æ¡£',
                    'æ£€æŸ¥ç½‘ç»œè¯·æ±‚å¤´é…ç½®',
                    'è”ç³»é˜¿é‡Œäº‘æŠ€æœ¯æ”¯æŒ'
                ];
            }

            showDiagnosis(diagnosis, 'error');
            showSolutions(solutions);
        }

        function showDiagnosis(message, type) {
            const diagnosisElement = document.getElementById('diagnosisResult');
            diagnosisElement.innerHTML = `
                <div class="log-entry log-${type}">${message}</div>
            `;
        }

        function showSolutions(steps) {
            const solutionsElement = document.getElementById('solutionSteps');
            solutionsElement.innerHTML = steps.map(step => 
                `<p>â€¢ ${step}</p>`
            ).join('');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            log('é¡µé¢è®¿é—®ç›‘æ§è¯Šæ–­å·¥å…·å·²åŠ è½½', 'success');
        });
    </script>
</body>
</html>
