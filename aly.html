<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>页面访问监控系统 - 诊断工具</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        .panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            border-left: 4px solid #4facfe;
        }
        .panel h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.4em;
        }
        .config-section {
            grid-column: 1 / -1;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-group input:focus {
            outline: none;
            border-color: #4facfe;
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn-primary {
            background: #4facfe;
            color: white;
        }
        .btn-primary:hover {
            background: #3a9bfc;
            transform: translateY(-2px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        .status-log {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 4px;
        }
        .log-success { background: #28a745; }
        .log-error { background: #dc3545; }
        .log-warning { background: #ffc107; color: #212529; }
        .log-info { background: #17a2b8; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }
        .info-item strong {
            display: block;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        .request-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .json-view {
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
        }
        .diagnosis-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        .solution-steps {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            .config-section {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 页面访问监控系统诊断工具</h1>
            <p>诊断和解决阿里云函数计算连接问题</p>
        </div>
        
        <div class="content">
            <div class="panel config-section">
                <h2>⚙️ 函数配置</h2>
                <div class="input-group">
                    <label for="functionUrl">函数计算URL地址：</label>
                    <input type="text" id="functionUrl" 
                           value="https://page-mofunction-khbohtokia.cn-hangzhou.fcapp.run"
                           placeholder="请输入您的函数计算URL">
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveConfig()">💾 保存配置</button>
                    <button class="btn btn-info" onclick="testConnection()">🔗 测试连接</button>
                    <button class="btn btn-success" onclick="sendAccessRecord()">📨 发送访问记录</button>
                    <button class="btn btn-warning" onclick="testWithMockData()">🧪 模拟数据测试</button>
                    <button class="btn btn-danger" onclick="clearLog()">🗑️ 清除日志</button>
                </div>
            </div>

            <div class="panel">
                <h2>📊 系统状态</h2>
                <div class="status-log" id="statusLog">
                    <div class="log-entry log-info">系统就绪，等待操作...</div>
                </div>
            </div>

            <div class="panel">
                <h2>🌐 访问环境信息</h2>
                <div class="info-grid" id="environmentInfo">
                    <!-- 环境信息将通过JavaScript动态生成 -->
                </div>
            </div>

            <div class="panel">
                <h2>📝 请求详情</h2>
                <div class="request-details">
                    <strong>请求URL：</strong>
                    <div id="requestUrl">等待配置...</div>
                    
                    <strong>请求数据：</strong>
                    <div class="json-view" id="requestData">等待请求...</div>
                    
                    <strong>响应状态：</strong>
                    <div id="responseStatus">未发送</div>
                    
                    <strong>响应数据：</strong>
                    <div class="json-view" id="responseData">等待响应...</div>
                </div>
            </div>

            <div class="diagnosis-section">
                <h2>🔧 问题诊断</h2>
                <div id="diagnosisResult">
                    <p>点击"测试连接"开始诊断...</p>
                </div>
            </div>

            <div class="solution-steps">
                <h2>💡 解决方案</h2>
                <div id="solutionSteps">
                    <p>根据诊断结果提供具体解决方案...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 配置管理
        const CONFIG_KEY = 'fc_monitor_config';
        
        // 初始化配置
        function loadConfig() {
            const saved = localStorage.getItem(CONFIG_KEY);
            if (saved) {
                const config = JSON.parse(saved);
                document.getElementById('functionUrl').value = config.url || '';
            }
            updateEnvironmentInfo();
        }

        // 保存配置
        function saveConfig() {
            const url = document.getElementById('functionUrl').value.trim();
            if (!url) {
                log('请输入有效的URL地址', 'error');
                return;
            }
            
            const config = { url, timestamp: new Date().toISOString() };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
            log('配置已保存', 'success');
            updateRequestDetails();
        }

        // 更新环境信息
        function updateEnvironmentInfo() {
            const info = {
                '页面URL': window.location.href,
                '用户代理': navigator.userAgent,
                '屏幕分辨率': `${screen.width} × ${screen.height}`,
                '色彩深度': `${screen.colorDepth}位`,
                '语言设置': navigator.language,
                '来源页面': document.referrer || '直接访问',
                'Cookie启用': navigator.cookieEnabled ? '是' : '否',
                '在线状态': navigator.onLine ? '在线' : '离线',
                '访问时间': new Date().toLocaleString(),
                '时区偏移': new Date().getTimezoneOffset() + '分钟'
            };

            const container = document.getElementById('environmentInfo');
            container.innerHTML = '';
            
            Object.entries(info).forEach(([key, value]) => {
                const item = document.createElement('div');
                item.className = 'info-item';
                item.innerHTML = `<strong>${key}</strong><span>${value}</span>`;
                container.appendChild(item);
            });
        }

        // 测试连接
        async function testConnection() {
            const url = getFunctionUrl();
            if (!url) return;

            log(`测试连接到: ${url}`, 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'OPTIONS',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': window.location.origin
                    }
                });
                
                if (response.ok) {
                    log('✅ 连接测试成功 - 服务可访问', 'success');
                    showDiagnosis('连接正常', 'success');
                    showSolutions(['服务正常运行，可以发送访问记录']);
                } else {
                    log(`❌ 连接测试失败: ${response.status} ${response.statusText}`, 'error');
                    diagnoseConnectionIssue(response.status);
                }
            } catch (error) {
                log(`❌ 连接错误: ${error.message}`, 'error');
                diagnoseConnectionIssue(0, error.message);
            }
        }

        // 发送访问记录
        async function sendAccessRecord() {
            const url = getFunctionUrl();
            if (!url) return;

            const requestData = {
                pageUrl: window.location.href,
                userAgent: navigator.userAgent,
                referer: document.referrer,
                screen: `${screen.width}x${screen.height}`,
                language: navigator.language,
                timestamp: Date.now()
            };

            log('准备发送访问记录...', 'info');
            updateRequestDetails(url, requestData);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const responseText = await response.text();
                updateResponseDetails(response.status, responseText);

                if (response.ok) {
                    log('✅ 访问记录发送成功', 'success');
                } else {
                    log(`❌ 发送失败: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ 网络错误: ${error.message}`, 'error');
                updateResponseDetails(0, error.message);
            }
        }

        // 模拟数据测试
        async function testWithMockData() {
            const url = getFunctionUrl();
            if (!url) return;

            const mockData = {
                pageUrl: "https://example.com/test-page",
                userAgent: "Mozilla/5.0 (测试用户代理)",
                referer: "https://google.com",
                screen: "1920x1080",
                language: "zh-CN",
                timestamp: Date.now(),
                testMode: true
            };

            log('使用模拟数据进行测试...', 'info');
            updateRequestDetails(url, mockData);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(mockData)
                });

                const responseText = await response.text();
                updateResponseDetails(response.status, responseText);

                if (response.ok) {
                    log('✅ 模拟测试成功', 'success');
                } else {
                    log(`❌ 模拟测试失败: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`❌ 模拟测试错误: ${error.message}`, 'error');
                updateResponseDetails(0, error.message);
            }
        }

        // 工具函数
        function getFunctionUrl() {
            const url = document.getElementById('functionUrl').value.trim();
            if (!url) {
                log('请先配置函数URL地址', 'error');
                return null;
            }
            return url;
        }

        function updateRequestDetails(url, data) {
            document.getElementById('requestUrl').textContent = url || '未配置';
            document.getElementById('requestData').textContent = data ? 
                JSON.stringify(data, null, 2) : '等待请求...';
        }

        function updateResponseDetails(status, data) {
            document.getElementById('responseStatus').textContent = 
                status ? `${status} ${getStatusText(status)}` : '请求失败';
            document.getElementById('responseData').textContent = 
                data ? (typeof data === 'string' ? data : JSON.stringify(data, null, 2)) : '无响应数据';
        }

        function getStatusText(status) {
            const statusTexts = {
                200: 'OK', 201: 'Created', 400: 'Bad Request', 
                401: 'Unauthorized', 403: 'Forbidden', 404: 'Not Found',
                500: 'Internal Server Error'
            };
            return statusTexts[status] || 'Unknown Status';
        }

        function log(message, type = 'info') {
            const logElement = document.getElementById('statusLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleString()} - ${message}`;
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('statusLog').innerHTML = 
                '<div class="log-entry log-info">日志已清除</div>';
        }

        function diagnoseConnectionIssue(status, errorMessage = '') {
            let diagnosis = '';
            let solutions = [];

            if (status === 0) {
                diagnosis = '网络连接完全失败';
                solutions = [
                    '检查URL地址是否正确（应以https://开头）',
                    '尝试使用curl命令测试：curl -X POST "您的URL"',
                    '检查网络防火墙设置',
                    '尝试更换网络环境或使用VPN',
                    '确认函数计算服务是否正常运行'
                ];
            } else if (status === 403) {
                diagnosis = '访问被拒绝（认证问题）';
                solutions = [
                    '检查触发器认证方式是否为"匿名"',
                    '确认函数执行角色有足够权限',
                    '检查API网关的访问控制设置'
                ];
            } else if (status === 404) {
                diagnosis = '服务未找到';
                solutions = [
                    '确认URL地址完全正确',
                    '检查函数是否已部署成功',
                    '确认触发器配置正确'
                ];
            } else if (status === 500) {
                diagnosis = '服务器内部错误';
                solutions = [
                    '检查函数代码是否有语法错误',
                    '查看函数计算日志详情',
                    '确认环境变量配置正确'
                ];
            } else {
                diagnosis = `HTTP ${status} 错误`;
                solutions = [
                    '查看阿里云函数计算文档',
                    '检查网络请求头配置',
                    '联系阿里云技术支持'
                ];
            }

            showDiagnosis(diagnosis, 'error');
            showSolutions(solutions);
        }

        function showDiagnosis(message, type) {
            const diagnosisElement = document.getElementById('diagnosisResult');
            diagnosisElement.innerHTML = `
                <div class="log-entry log-${type}">${message}</div>
            `;
        }

        function showSolutions(steps) {
            const solutionsElement = document.getElementById('solutionSteps');
            solutionsElement.innerHTML = steps.map(step => 
                `<p>• ${step}</p>`
            ).join('');
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            log('页面访问监控诊断工具已加载', 'success');
        });
    </script>
</body>
</html>
