<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>行政区划选择系统 - 百度地图版</title>
    <style>
        /* 样式保持原有优化 */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        select {
            width: 100%;
            padding: 1rem;
            margin: 1rem 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        .error {
            color: #dc3545;
            padding: 1rem;
            background: #ffeef0;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>请选择收货地址</h2>
        <select id="province" disabled>
            <option value="">正在加载省份...</option>
        </select>
        <select id="city" disabled>
            <option value="">请先选择省份</option>
        </select>
        <select id="district" disabled>
            <option value="">请先选择城市</option>
        </select>
        <div id="error" class="error" style="display: none;"></div>
    </div>

<script>
// 百度地图配置
const BAIDU_CONFIG = {
    ak: 'S89EnnZyjlokQEwbtkue4bbAlM80oav5', // 您的AK
    api_endpoint: 'https://api.map.baidu.com/api_region/v1/list',
    extensions: 2  // 返回行政区边界坐标
};

// 初始化加载
window.addEventListener('DOMContentLoaded', async () => {
    try {
        // 加载省级数据
        const provinceData = await fetchBaiduData('province');
        renderOptions('province', provinceData);
    } catch (error) {
        handleError(error);
    }
});

// 百度API请求封装
async function fetchBaiduData(level, parentId = null) {
    const params = {
        ak: BAIDU_CONFIG.ak,
        extensions: BAIDU_CONFIG.extensions,
        output: 'json'
    };

    // 构造请求参数
    switch(level) {
        case 'province':
            params.region = '中国';
            break;
        case 'city':
            params.region = parentId.toString();
            break;
        case 'district':
            params.region = parentId.toString();
            params.level = 'district';
            break;
    }

    const url = new URL(BAIDU_CONFIG.api_endpoint);
    Object.entries(params).forEach(([k, v]) => {
        url.searchParams.append(k, v);
    });

    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
    
    const data = await response.json();
    if (data.status !== 0) {
        throw new Error(`百度API错误: ${data.message} (状态码:${data.status})`);
    }
    
    return data.districts[0]?.districts || [];
}

// 渲染选项（适配百度数据结构）
function renderOptions(targetId, items) {
    const select = document.getElementById(targetId);
    select.disabled = false;
    select.innerHTML = items.map(item => 
        `<option value="${item.code}">${item.name}</option>`
    ).join('');
    
    // 动态绑定下级加载
    if (targetId === 'province') {
        select.addEventListener('change', async (e) => {
            try {
                const cityData = await fetchBaiduData('city', e.target.value);
                renderOptions('city', cityData);
                document.getElementById('district').innerHTML = '<option value="">请先选择城市</option>';
            } catch (error) {
                handleError(error);
            }
        });
    }
    
    if (targetId === 'city') {
        select.addEventListener('change', async (e) => {
            try {
                const districtData = await fetchBaiduData('district', e.target.value);
                renderOptions('district', districtData);
            } catch (error) {
                handleError(error);
            }
        });
    }
}

// 错误处理（保持原有逻辑）
function handleError(error) {
    console.error(error);
    const errorMsg = error.message.includes('AK') ? 
        'AK配置错误，请检查控制台设置' :
        error.message;
    showError(errorMsg);
}

function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.style.display = 'block';
    errorDiv.textContent = `错误: ${message}`;
}
</script>
</body>
</html>
