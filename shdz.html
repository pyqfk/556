<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡Œæ”¿åŒºåˆ’é€‰æ‹©ç³»ç»Ÿ - æ­£å¼ç‰ˆ</title>
    <style>
        .container {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            font-family: "Microsoft YaHei", sans-serif;
            background: #f8f9fa;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            margin: 8px 0;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            border-color: #4dabf7;
            box-shadow: 0 0 0 3px rgba(77, 171, 247, 0.2);
        }

        .loading {
            color: #495057;
            padding: 15px;
            text-align: center;
            font-size: 14px;
        }

        .error {
            color: #e03131;
            padding: 15px;
            text-align: center;
            font-weight: 500;
        }

        .retry-btn {
            display: block;
            width: 100%;
            padding: 14px;
            background: #339af0;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background 0.3s;
        }

        .retry-btn:hover {
            background: #228be6;
        }

        .cache-info {
            color: #868e96;
            font-size: 12px;
            text-align: right;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2 style="color: #2b2d42; text-align: center; margin-bottom: 30px;">ğŸ“¦ æ”¶è´§åœ°å€å¡«å†™</h2>
        
        <div class="form-group">
            <select id="province" onchange="loadChildren('province', this.value)">
                <option value="">è¯·é€‰æ‹©çœä»½</option>
            </select>
        </div>
        
        <div class="form-group">
            <select id="city" disabled onchange="loadChildren('city', this.value)">
                <option value="">è¯·é€‰æ‹©åŸå¸‚</option>
            </select>
        </div>
        
        <div class="form-group">
            <select id="district" disabled>
                <option value="">è¯·é€‰æ‹©åŒºå¿</option>
            </select>
        </div>
        
        <div class="form-group">
            <input type="text" placeholder="è¯¦ç»†åœ°å€ï¼ˆå¦‚è¡—é“é—¨ç‰Œå·ï¼‰" id="address">
        </div>
        
        <div class="form-group">
            <input type="text" placeholder="æ”¶è´§äººå§“å" id="name">
        </div>
        
        <div class="form-group">
            <input type="tel" placeholder="è”ç³»ç”µè¯ï¼ˆ11ä½æ‰‹æœºå·ï¼‰" pattern="\d{11}" id="phone">
        </div>
        
        <div class="loading" id="loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
        <div class="error" id="error"></div>
        <button class="retry-btn" onclick="retryLoad()" style="display: none;" id="retryBtn">ğŸ”„ é‡æ–°åŠ è½½æ•°æ®</button>
        <div class="cache-info" id="cacheInfo"></div>
    </div>

<script>
// é…ç½®å‚æ•°ï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨çš„æœ‰æ•ˆKeyï¼‰
const CONFIG = {
    key: 'UGFBZ-XO2KZ-DTCXA-7EDBP-W2F4K-KYFNR',
    cacheExpire: 86400, // æœ¬åœ°ç¼“å­˜æ—¶é—´ï¼ˆç§’ï¼‰
    maxRetry: 3,        // æœ€å¤§é‡è¯•æ¬¡æ•°
    apiEndpoint: 'https://apis.map.qq.com/ws/district/v1/list'
};

// åˆå§‹åŒ–æ‰§è¡Œ
window.onload = () => {
    checkCache();
    loadProvince().catch(handleFatalError);
};

// ç¼“å­˜ç®¡ç†
function checkCache() {
    const lastUpdate = localStorage.getItem('lastUpdate');
    if (lastUpdate) {
        const diff = Math.floor((Date.now() - lastUpdate) / 1000);
        document.getElementById('cacheInfo').textContent = `æœ¬åœ°ç¼“å­˜æ•°æ®ï¼ˆ${diff}ç§’å‰æ›´æ–°ï¼‰`;
    }
}

// çœçº§æ•°æ®åŠ è½½
async function loadProvince() {
    try {
        showLoading('æ­£åœ¨åŠ è½½çœä»½æ•°æ®...');
        
        // å°è¯•è¯»å–ç¼“å­˜
        const cacheKey = 'province_data';
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
            const data = JSON.parse(cachedData);
            renderOptions('province', data);
            return;
        }

        // å‘èµ·APIè¯·æ±‚
        const params = new URLSearchParams({
            key: CONFIG.key,
            level: 'province'
        });
        
        const response = await fetchWithRetry(`${CONFIG.apiEndpoint}?${params}`);
        const data = await processResponse(response);
        
        // ç¼“å­˜æ•°æ®
        localStorage.setItem(cacheKey, JSON.stringify(data));
        localStorage.setItem('lastUpdate', Date.now());
        
        renderOptions('province', data);
        showLoading('');
        
    } catch (error) {
        handleDataError('çœä»½', error);
    }
}

// ä¸‹çº§æ•°æ®åŠ è½½
async function loadChildren(type, code) {
    try {
        const levelMap = { province: 'city', city: 'district' };
        const nextLevel = levelMap[type];
        showLoading(`æ­£åœ¨åŠ è½½${nextLevel === 'city' ? 'åŸå¸‚' : 'åŒºå¿'}æ•°æ®...`);

        const cacheKey = `${type}_${code}`;
        const cachedData = localStorage.getItem(cacheKey);
        if (cachedData) {
            const data = JSON.parse(cachedData);
            renderOptions(nextLevel, data);
            resetChildren(type);
            return;
        }

        const params = new URLSearchParams({
            key: CONFIG.key,
            level: nextLevel,
            id: code
        });
        
        const response = await fetchWithRetry(`${CONFIG.apiEndpoint}?${params}`);
        const data = await processResponse(response);
        
        localStorage.setItem(cacheKey, JSON.stringify(data));
        renderOptions(nextLevel, data);
        resetChildren(type);
        showLoading('');
        
    } catch (error) {
        handleDataError('æ•°æ®', error);
    }
}

// é€šç”¨è¯·æ±‚æ–¹æ³•
async function fetchWithRetry(url, retryCount = 0) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return response;
    } catch (error) {
        if (retryCount < CONFIG.maxRetry) {
            await new Promise(resolve => setTimeout(resolve, 2000));
            return fetchWithRetry(url, retryCount + 1);
        }
        throw error;
    }
}

// å¤„ç†APIå“åº”
async function processResponse(response) {
    const data = await response.json();
    if (data.status !== 0) throw new Error(data.message);
    return data.result[0] || [];
}

// æ¸²æŸ“ä¸‹æ‹‰é€‰é¡¹
function renderOptions(targetId, items) {
    const select = document.getElementById(targetId);
    select.disabled = false;
    select.innerHTML = `<option value="">è¯·é€‰æ‹©</option>` + 
        items.map(item => `
            <option value="${item.id}" 
                    data-lng="${item.location?.lng}" 
                    data-lat="${item.location?.lat}">
                ${item.fullname}
            </option>
        `).join('');
}

// é‡ç½®ä¸‹çº§èœå•
function resetChildren(currentType) {
    const targets = {
        province: ['city', 'district'],
        city: ['district']
    }[currentType] || [];
    
    targets.forEach(target => {
        const select = document.getElementById(target);
        select.innerHTML = `<option value="">è¯·é€‰æ‹©</option>`;
        select.disabled = true;
    });
}

// é”™è¯¯å¤„ç†
function handleDataError(type, error) {
    console.error(`${type}åŠ è½½é”™è¯¯:`, error);
    showError(`${type}åŠ è½½å¤±è´¥: ${error.message}`, true);
}

function handleFatalError(error) {
    console.error('è‡´å‘½é”™è¯¯:', error);
    showError('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', true);
}

// ç•Œé¢çŠ¶æ€æ§åˆ¶
function showLoading(text) {
    const loading = document.getElementById('loading');
    loading.textContent = text;
}

function showError(message, showButton = false) {
    const errorDiv = document.getElementById('error');
    errorDiv.textContent = message;
    document.getElementById('retryBtn').style.display = showButton ? 'block' : 'none';
    showLoading('');
}

// é‡è¯•æœºåˆ¶
function retryLoad() {
    document.getElementById('error').textContent = '';
    document.getElementById('retryBtn').style.display = 'none';
    localStorage.clear();
    window.location.reload();
}
</script>
</body>
</html>
