<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>行政区划选择系统 - 安全版</title>
    <style>
        /* 样式优化 */
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        select {
            width: 100%;
            padding: 1rem;
            margin: 1rem 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        .error {
            color: #dc3545;
            padding: 1rem;
            background: #ffeef0;
            border-radius: 8px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>请选择收货地址</h2>
        <select id="province" disabled>
            <option value="">正在加载省份...</option>
        </select>
        <select id="city" disabled>
            <option value="">请先选择省份</option>
        </select>
        <select id="district" disabled>
            <option value="">请先选择城市</option>
        </select>
        <div id="error" class="error" style="display: none;"></div>
    </div>

<script>
// 配置参数（需用户自行修改）
const CONFIG = {
    key: 'UGFBZ-XO2KZ-DTCXA-7EDBP-W2F4K-KYFNR', // 替换为有效Key
    domain: 'pyqfk.github.io',          // 白名单域名
    enableSN: false                             // 是否启用签名校验
};

// 腾讯地图API端点
const API_ENDPOINT = 'https://apis.map.qq.com/ws/district/v1/list';

// 初始化加载
window.addEventListener('DOMContentLoaded', async () => {
    try {
        // 环境检测
        if (!verifyDomain()) {
            showError('域名未授权访问，请检查白名单配置');
            return;
        }
        
        // 加载省级数据
        const data = await fetchData({ level: 'province' });
        renderOptions('province', data);
    } catch (error) {
        handleError(error);
    }
});

// 安全数据请求
async function fetchData(params) {
    const url = new URL(API_ENDPOINT);
    const baseParams = {
        key: CONFIG.key,
        output: 'jsonp',
        callback: 'jsonpCallback'
    };

    // 合并参数
    const finalParams = { ...baseParams, ...params };
    
    // 生成签名（如果启用）
    if (CONFIG.enableSN) {
        finalParams.sig = await generateSignature(finalParams);
    }

    // 添加参数到URL
    Object.entries(finalParams).forEach(([k, v]) => {
        url.searchParams.append(k, v);
    });

    return new Promise((resolve, reject) => {
        // JSONP回调处理
        window.jsonpCallback = (response) => {
            if (response.status === 0) {
                resolve(response.result[0]);
            } else {
                reject(new Error(`API错误: ${response.message} (代码:${response.status})`));
            }
        };

        // 创建脚本标签
        const script = document.createElement('script');
        script.src = url;
        script.onerror = () => reject(new Error('网络请求失败'));
        document.body.appendChild(script);
    });
}

// 签名生成函数（示例，实际应在后端实现）
async function generateSignature(params) {
    // 警告：前端暴露SecretKey存在安全风险，生产环境应通过后端生成
    const secretKey = 'YOUR_SECRET_KEY'; 
    const paramStr = Object.keys(params)
        .sort()
        .map(key => `${key}=${params[key]}`)
        .join('&');
    
    const signStr = `${paramStr}${secretKey}`;
    const encoder = new TextEncoder();
    const hash = await crypto.subtle.digest('SHA-256', encoder.encode(signStr));
    return Array.from(new Uint8Array(hash))
        .map(b => b.toString(16).padStart(2, '0'))
        .join('');
}

// 域名验证
function verifyDomain() {
    const currentDomain = window.location.hostname;
    return currentDomain === CONFIG.domain || 
           currentDomain.endsWith('.' + CONFIG.domain);
}

// 渲染选项
function renderOptions(targetId, items) {
    const select = document.getElementById(targetId);
    select.disabled = false;
    select.innerHTML = items.map(item => 
        `<option value="${item.id}">${item.fullname}</option>`
    ).join('');
    
    // 绑定下级加载事件
    if (targetId === 'province') {
        select.addEventListener('change', async (e) => {
            try {
                const data = await fetchData({ 
                    level: 'city', 
                    id: e.target.value 
                });
                renderOptions('city', data);
            } catch (error) {
                handleError(error);
            }
        });
    }
    
    if (targetId === 'city') {
        select.addEventListener('change', async (e) => {
            try {
                const data = await fetchData({ 
                    level: 'district', 
                    id: e.target.value 
                });
                renderOptions('district', data);
            } catch (error) {
                handleError(error);
            }
        });
    }
}

// 错误处理
function handleError(error) {
    console.error(error);
    const errorMsg = error.message.includes('110') ? 
        '白名单配置错误，请检查控制台设置' :
        error.message;
    showError(errorMsg);
}

function showError(message) {
    const errorDiv = document.getElementById('error');
    errorDiv.style.display = 'block';
    errorDiv.textContent = `错误: ${message} (当前域名: ${window.location.hostname})`;
}
</script>
</body>
</html>
